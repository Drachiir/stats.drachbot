{% extends 'base.html' %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div class="container-lg" style="padding-top: 2vw; display: flex; gap: 20px; justify-content: center; align-items: flex-start;">
    <div style="background: #171717; border-radius: 10px; max-width: 60%;">
        <div style="padding: 10px; display: flex; flex-wrap: wrap; overflow: hidden; text-overflow: ellipsis; align-items: flex-start; justify-content: center">
            <div class="profile-div" style="text-align: center; width: 200px; overflow: hidden">
                <img style="vertical-align: middle; clip-path: circle();" src="https://cdn.legiontd2.com/{{ api_profile["avatarUrl"] }}">
                <r2 style="font-size: 1.5rem"><b>{{ api_profile["playerName"] }}</b></r2>
                <r2 style="color: gold;"><b> {{ api_profile["guildTag"] }}</b></r2><br>
                <button class="refresh-button" onclick="refreshPage()">Refresh</button>
            </div>
            <div class="profile-div">
                <r2 style=""><b>Season 2024 Stats:</b></r2><br>
                <r2>{{ api_stats["rankedWinsThisSeason"] }}W - {{ api_stats["rankedLossesThisSeason"] }}L<br>({{ winrate([api_stats["rankedWinsThisSeason"],
                (api_stats["rankedWinsThisSeason"]+api_stats["rankedLossesThisSeason"])]) }} WR%)</r2><br>
                <img width="32" height="auto" style="vertical-align: middle" src="{{ get_rank_url(api_stats["overallElo"]) }}">
                <r2>{{ api_stats["overallElo"] }} </r2><r2 style="color: #919191">Current</r2><br>
                <img width="32" height="auto" style="vertical-align: middle" src="{{ get_rank_url(api_stats["overallPeakEloThisSeason"]) }}">
                <r2>{{ api_stats["overallPeakEloThisSeason"] }} </r2><r2 style="color: #919191">Peak</r2>
            </div>
            <div class="profile-div">
                <r2> <b>Stat Pages:</b></r2><br>
                {% for stat in stats_list %}
                    <a style="color: white; text-decoration: none;" href="/profile/{{ playername }}/{{ stat }}">
                    <img width="32" height="auto" style="vertical-align: middle" src="{{ image_list[loop.index0]}}">
                    <r2>[{{ stat.capitalize() }}]</r2><br></a>
                {% endfor %}
            </div>
            <div class="profile-div">
                <r2><b>Last {{ history|length }} Games:</b></r2><br>
                <r2>{{ winlose[0] }}W - {{ winlose[1] }}L<br>({{ winrate([winlose[0], (winlose[0]+winlose[1])]) }} WR%)</r2><br>
                <r2>Elo Diff: {{ elochange }}</r2>
            </div>
            <div class="profile-div">
                <r2>Wave 1 Tendency:</r2><br>
                <img width="32" height="auto" src="https://cdn.legiontd2.com/icons/UpgradeKingAttack.png"><r2>{{ wave1[0] }}%</r2>
                <img width="32" height="auto" src="https://cdn.legiontd2.com/icons/Snail.png"><r2>{{ wave1[1] }}%</r2>
                <img width="32" height="auto" src="https://cdn.legiontd2.com/icons/Mythium32.png"><r2>{{ wave1[2] }}%</r2>
            </div>
            <div class="profile-div">
                <r2>Favorite Openers:</r2><br>
                {% for open in openers %}
                    <img width="32" height="auto" src="{{ get_cdn(open, "Opener") }}">
                {% endfor %}
            </div>
            <div class="profile-div">
                <r2>Favorite Masterminds:</r2><br>
                {% for mm in mms %}
                    <img width="32" height="auto" src="{{ get_cdn(mm, "MMs") }}">
                {% endfor %}
            </div>
        </div>
        <div class="profile-div" style="width: 10%; float: right">
                <div class="form-group">
                    <div class="input-group">
                        <input type="number" id="dataLimit" class="form-control" value="100" min="1" />
                        <div class="input-group-append">
                            <button class="btn btn-primary" onclick="updateChart()">Apply Limit</button>
                        </div>
                    </div>
                </div>
            </div>
        <div id="chart-container">
            <canvas id="myChart"></canvas>
        </div>
    </div>
    <div style="max-height: 85vh; overflow-y: scroll; border-radius: 10px;">
        <r2 style="font-size: 1.5rem">Match History</r2>
    {% for game in history %}
        <a style="color: white; text-decoration: none;"  href="{{ game["ltd2pro"] }}">
        <div style="background: #171717; border-radius: 10px; display: flex; padding-right: 10px">
            <div>
                <div>
                    <img width="48" style="vertical-align: middle; clip-path: circle();" src="{{ game["EndWave"] }}">
                    <r2>{{ game["Result_String"] }} ({{ game["EloChange"] }} Elo) </r2>
                </div>
                <div>
                    <r2 style="color: #a5a5a5;">{{ game["time_ago"] }}</r2>
                </div>
            </div>
        </div></a><br>
    {% endfor %}
    </div>
</div>
<script>
    // Get the labels and values from Flask (Jinja2 templating)
    const labels = {{ labels|tojson }};
    const values = {{ values|tojson }};
    const dataLength = labels.length;

    // Set up the chart
    const ctx = document.getElementById('myChart').getContext('2d');
    let myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Elo',
                data: values,
                backgroundColor: 'rgba(67,144,255,0.91)',
                borderColor: 'rgb(79,189,237)',
                borderWidth: 1,
                pointRadius: 0  // Remove dots
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    ticks: {
                        maxTicksLimit: 20,
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.2)',
                        borderColor: 'rgba(255, 255, 255, 0.5)',
                        borderWidth: 1
                    }
                },
                y: {
                    beginAtZero: false,
                    ticks: {
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.2)',
                        borderColor: 'rgba(255, 255, 255, 0.5)',
                        borderWidth: 1
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: `Last ${labels.length} Ranked Games (Season 2024)`,
                    font: {
                        size: 14  // Smaller title font size
                    },
                    padding: {
                        top: 10,  // Reduce space above title
                        bottom: 10  // Ensure some space below title
                    }
                },
                tooltip: {
                    enabled: true,
                    mode: 'nearest',
                    intersect: false
                }
            },
            layout: {
                padding: {
                    top: 5,  // Reduce padding at the top
                    bottom: 20
                }
            }
        }
    });

    // Function to update chart based on user input
    function updateChart() {
        let limit = parseInt(document.getElementById('dataLimit').value, 10);

        // Adjust limit if it exceeds available data length
        if (limit > dataLength) {
            limit = dataLength;
            document.getElementById('dataLimit').value = limit;
        }

        if (limit > 0) {
            const limitedLabels = labels.slice(-limit);
            const limitedValues = values.slice(-limit);

            // Update chart data
            myChart.data.labels = limitedLabels;
            myChart.data.datasets[0].data = limitedValues;

            // Recalculate min and max values
            const minValue = Math.min(...limitedValues);
            const maxValue = Math.max(...limitedValues);
            myChart.options.scales.y.min = minValue - 10;
            myChart.options.scales.y.max = maxValue + 10;

            // Update chart title
            myChart.options.plugins.title.text = `Last ${limit} Ranked Games`;

            // Refresh the chart
            myChart.update();
        } else {
            alert("Please enter a valid number greater than 0.");
        }
    }

    // Initialize the input field with the maximum value based on the data length
    document.getElementById('dataLimit').setAttribute('max', dataLength);
    document.getElementById('dataLimit').value = Math.min(100, dataLength); // Default to 100 or max available data
</script>

{% endblock %}