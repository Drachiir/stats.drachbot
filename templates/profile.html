{% extends 'base.html' %}
{% block html_head %}
    <meta name="robots" content="noindex">
{% endblock %}
{% block content %}
<style>
    :root{
        --textsize: clamp(0.6rem, 1vw, 1.2rem);
        --waveimgsize: clamp(36px, 5vw, 48px);
        --imgsize: clamp(20px, 3vw, 28px);
        --blueAccent: #0095ff;
        --blackBg: rgba(23, 23, 23, 0.95);
    }
    r {
      font-family: "Roboto", sans-serif;
      font-weight: 300;
      font-style: normal;
    }
    r2 {
        font-family: "Roboto", sans-serif;
        font-weight: 300;
        font-style: normal;
        vertical-align: middle;
        font-size: 1rem;
    }
    r3 {
        font-family: "Roboto", monospace;
        font-weight: 300;
        font-style: normal;
        font-size: 0.85rem;
    }
    .profile-div {
        min-width: max-content;
        min-height: max-content;
        white-space: nowrap; /* Prevents text from wrapping inside the div */
        margin: 6px;
    }
    #chart-container {
        width: 100%; /* Ensure it takes full width */
        height: 375px; /* You can adjust the height */
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* Make sure the canvas stretches within the container */
    canvas {
        width: 100% !important;
        height: 100% !important;
    }
    .profile-main {
        background: var(--blackBg);
        border-radius: 10px;
        box-shadow:inset 0 0 0 1px #2c2c2c;
    }
    @media (max-width: 480px) {
        .profile-main {
            max-width: 100%;
        }
    }
    @media (max-width: 768px) {
        .profile-main{
            max-width: 100%;
        }
    }
    table th{
        opacity: .85;
        background-color: #222223 !important;
    }
    table td{
        background-color: rgba(0, 0, 0, 0) !important;
    }
    .player-row:hover{
        cursor: pointer;
    }
    [data-title]:hover::after, [data-title]:active::after{
        content: attr(data-title);
        background-color: black;
        font-family: "Roboto", sans-serif;
        text-align: center;
        border-radius: 10px;
        padding: 5px;
        border: gray 1px solid;
        position: absolute;
        z-index: 1;
    }
    [names-tooltip]:hover::after, [names-tooltip]:active::after{
        content: attr(names-tooltip);
        background-color: black;
        font-size: 1rem;
        font-family: "Roboto", sans-serif;
        text-align: center;
        border-radius: 10px;
        max-width: 80%;
        text-wrap: wrap;
        padding: 3px;
        left: 64px;
        top: 90%;
        border: var(--blueAccent) 1px solid;
        position: absolute;
        z-index: 1;
    }
    /* Apply custom styles to scrollable div */
    .scrollable {
        height: 170px;   /* Adjust the height as needed */
        overflow-y: auto; /* Enable vertical scrolling */
        width: 100%;
    }
    /* Custom scrollbar styles for WebKit browsers (Chrome, Safari, etc.) */
    .scrollable::-webkit-scrollbar {
        width: 12px; /* Width of the scrollbar */
    }
    /* Track - the background of the scrollbar */
    .scrollable::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0); /* Light gray background */
    }
    /* Handle - the draggable part of the scrollbar */
    .scrollable::-webkit-scrollbar-thumb {
        background: var(--blueAccent); /* Darker gray handle */
        border-radius: 10px; /* Round edges */
    }
    /* Handle on hover */
    .scrollable::-webkit-scrollbar-thumb:hover {
        background: var(--blueAccent); /* Darker on hover */
    }
    .strokeText{
        -webkit-text-stroke: 3px black;
        paint-order: stroke fill;
        font-weight: 400;
    }
    .clickableDiv{
        cursor: pointer;
        box-shadow:inset 0 0 0 1px #2c2c2c;
        transition: background-color 0.2s ease, border 0.2s ease;
    }
    .clickableDiv:hover{
        background-color: #1c1c1c !important;
    }
    .highlight {
        background-color: var(--blueAccent) !important; /* Green background for the button */
    }
    .fav-imgs{
        transition: transform 0.2s ease, border 0.2s ease;
    }
    .fav-imgs:hover{
        transform: scale(1.1);
    }
    #loading-spinner {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
        display: none; /* Initially hidden */
        text-align: center;
    }

    .spinner {
        border: 8px solid rgb(255, 255, 255);
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 100px;
        height: 100px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .matchhistoryPlayerName {
      display: inline-block;
      border: 1px solid transparent;
      border-radius: 10px;
      color: #1e90ff; /* Dodger Blue */
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .matchhistoryPlayerName:hover {
      border-color: #1e90ff;
      box-shadow: 0 0 2px rgba(30, 144, 255, 0.6);
      transform: translateY(-1px);
      background-color: rgba(30, 144, 255, 0.1);
    }

    .small-subtle-text{
        font-size: 12px;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<div class="container-lg" style="padding-top: 2vw; display: block">
    <div class="profile-main" style="position: relative">
        <div style="padding: 8px; display: flex; flex-wrap: wrap; overflow: hidden; align-items: flex-start; justify-content: space-evenly">
            <div style="text-align: center; width: max-content;">
                <div style="padding-bottom: 10px; position: relative; text-wrap: nowrap; text-overflow: ellipsis; text-align: left;">
                    <img style="vertical-align: middle;" src="https://cdn.legiontd2.com/{{ api_profile["avatarUrl"] }}">
                    {% if api_stats["avatarBorder"] %}
                        <img style="position: absolute; left: 0; top: 0" src="/{{ api_stats["avatarBorder"] }}">
                    {% endif %}
                    {% if known_names|length > 0 %}
                        {% set names_tooltip = ('Aka: ' + known_names|join(", ")) %}
                        <r2 names-tooltip="{{ names_tooltip }}" style="font-size: 1.5rem"><b>{{ api_profile["playerName"] }}<span style="color: var(--blueAccent)">*</span></b></r2>
                    {% else %}
                        <r2 style="font-size: 1.5rem"><b>{{ api_profile["playerName"] }}</b></r2>
                    {% endif %}
                    <r2 style="color: gold;"><b> {{ api_profile["guildTag"] }}</b></r2>
                    <div style="position: absolute; bottom: 5px; left: 70px">
                        {% if player_rank %}
                            <r2 style="color: gold;">Rank #{{ player_rank }}</r2>
                        {% endif %}
                        {% if api_stats["flag"] and not hide_flag_on_profile %}
                            <img title="{{ api_stats["Country"] }}" src="https://cdn.legiontd2.com/flags/4x3/{{ api_stats["flag"]|lower }}.png">
                        {% endif %}
                        {% if twitch_username %}
                            <a href="https://twitch.tv/{{ twitch_username|e }}" target="_blank" rel="noopener noreferrer" style="color: #9146ff; text-decoration: none; height: 48px">
                                <img src="https://static.twitchcdn.net/assets/favicon-32-e29e246c157142c94346.png" alt="Twitch" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 4px;">
                            </a>
                        {% endif %}
                        {% if youtube_username %}
                            <a href="https://youtube.com/@{{ youtube_username|e }}" target="_blank" rel="noopener noreferrer" style="color: #ff0000; text-decoration: none; height: 48px">
                                <img src="https://www.youtube.com/favicon.ico" alt="YouTube" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 4px;">
                            </a>
                        {% endif %}
                    </div>
                </div>
                <div>
                    <div>
                        <button class="btn btn-secondary" id="refresh-btn" {% if refresh_in_progress %}disabled{% endif %}>
                            {% if refresh_in_progress %}
                                Refreshing...
                            {% else %}
                                Refresh
                            {% endif %}
                        </button>
                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <r><b>Stats Pages</b></r>
                        </button>
                        <ul class="dropdown-menu bg-black">
                            {% for stat in stats_list %}
                                <li><a class="dropdown-item" style="color: white; text-decoration: none;" href="/load/{{ playerid }}/{{ stat }}/{{ patch }}">
                                    <div><img width="32" height="auto" style="vertical-align: middle" src="{{ image_list[loop.index0]}}"><r2>{{ stat.capitalize() }}</r2></div>
                                </a></li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="dropdown" style="padding-top: 4px">
                        <button class="btn btn-secondary" id="check-livegame-btn">Live Game</button>
                        <div class="modal fade" id="liveGameModal" tabindex="-1" aria-labelledby="liveGameModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content" style="background-color: #1c1c1c">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="liveGameModalLabel">Live Match Details</h5>
                                        <div style="display: flex; align-items: center; padding-left: 50px">
                                            <div id="toggle-sellout" class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-primary active" id="elo-toggle">Elo</button>
                                                <button type="button" class="btn btn-sm btn-primary" id="sellout-toggle">Sellout Score</button>
                                            </div>
                                            <a href="https://steamcommunity.com/sharedfiles/filedetails/?id=3351115892" target="_blank" style="margin-left: 8px; text-decoration: none;">
                                                <span title="Learn about Sellout Score">?</span>
                                            </a>
                                        </div>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body" id="liveGameDetails">
                                        <!-- Game details will be inserted here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Select Patches
                        </button>
                        <ul class="dropdown-menu bg-black" style="max-height: 400px; overflow-y: scroll" id="patchDropdown">
                            <form id="patchForm">
                                <li class="dropdown-item" id="patch-checkbox">
                                    <input type="checkbox" class="patch-checkbox" value="26">
                                     <label>v26.**</label>
                                </li>
                                {% for p in patch_list %}
                                    {% if p == "12.11" %}
                                        <li class="dropdown-item" id="patch-checkbox">
                                            <input type="checkbox" class="patch-checkbox" value="12">
                                            <label>v12.**</label>
                                        </li>
                                    {% endif %}
                                    {% if p == "11.11" %}
                                        <li class="dropdown-item" id="patch-checkbox">
                                            <input type="checkbox" class="patch-checkbox" value="11">
                                             <label>v11.**</label>
                                        </li>
                                    {% endif %}
                                    <li class="dropdown-item" id="patch-checkbox">
                                        <input type="checkbox" class="patch-checkbox" value="{{ p }}">
                                         <label>v{{ p }}</label>
                                    </li>
                                {% endfor %}
                            </form>
                            <li class="dropdown-item text-center" style="position: sticky; bottom: 0; background-color: #000000">
                                <button class="btn btn-primary w-100" id="redirectButton">Go</button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="profile-div">
                <r2 style=""><b>Season 2026 Stats</b></r2><br>
                <r2>{{ api_stats["rankedWinsThisSeason"] }}W - {{ api_stats["rankedLossesThisSeason"] }}L ({{ api_stats["rankedWinsThisSeason"] + api_stats["rankedLossesThisSeason"] }})
                <br>{{ winrate([api_stats["rankedWinsThisSeason"], (api_stats["rankedWinsThisSeason"]+api_stats["rankedLossesThisSeason"])]) }}% Winrate</r2><br>
                <img width="28" height="auto" style="vertical-align: middle" src="{{ get_rank_url(api_stats["overallElo"]) }}">
                <r2>{{ api_stats["overallElo"] }} </r2><r2 class="small-subtle-text" style="color: #919191">Current Elo</r2><br>
                <img width="28" height="auto" style="vertical-align: middle" src="{{ get_rank_url(api_stats["overallPeakEloThisSeason"]) }}">
                <r2>{{ api_stats["overallPeakEloThisSeason"] }} </r2><r2 class="small-subtle-text" style="color: #919191">Season Peak</r2>
                {% if api_stats["overallPeakElo"] > 0 %}
                    <br>
                    <img width="28" height="auto" style="vertical-align: middle" src="{{ get_rank_url(api_stats["overallPeakElo"]) }}">
                    <r2>{{ api_stats["overallPeakElo"] }} </r2><r2 class="small-subtle-text" style="color: #919191">Overall Peak</r2>
                {% endif %}
            </div>
            <div class="profile-div">
                <r2>
                    <b>Last {{ history|length }} Games </b>
                </r2>
                <i data-title="Patch: ({{ patch }})" style="font-size:14px; color: var(--blueAccent)" class="fa">?</i><br>
                <div class="button-container">
                    <button class="state-button" onclick="switchState('Overall')" id="btn-Overall">Total</button>
                    <button class="state-button" onclick="switchState('SoloQ')" id="btn-SoloQ">Solo</button>
                    <button class="state-button" onclick="switchState('DuoQ')" id="btn-DuoQ">Duo</button>
                </div>
                <div id="stats-display"></div>
            </div>
            <style>
                .button-container {
                    display: flex;
                    gap: 5px;
                    margin-bottom: 2px;
                }

                .state-button {
                    padding: 2px 3px;
                    font-size: 12px;
                    border: 1px solid var(--blueAccent);
                    border-radius: 5px;
                    background-color: #393939;
                    color: var(--blueAccent);
                    cursor: pointer;
                    transition: background-color 0.3s, color 0.3s;
                }

                .state-button:hover {
                    background-color: var(--blueAccent);
                    color: #393939;
                }

                .state-button.active {
                    background-color: var(--blueAccent);
                    color: #393939;
                }
            </style>
            <script>
                const winlose = {{ winlose | tojson }};
                const elochange = {{ elochange | tojson }};
                const mvpCount = {{ mvp_count | tojson }};
                const winrate = (wins, total) => (total > 0 ? ((wins / total) * 100).toFixed(1) : 0);

                function formatElo(elo) {
                    return elo > 0 ? `+${elo}` : elo;
                }

                function switchState(state) {
                    const statsDisplay = document.getElementById('stats-display');
                    const wins = winlose[state][0];
                    const losses = winlose[state][1];
                    const totalGames = wins + losses;
                    const wr = winrate(wins, totalGames);
                    const elo = formatElo(elochange[state]);
                    const mvp = mvpCount[state];

                    statsDisplay.innerHTML = `
                        <r2>${wins}W - ${losses}L<br>${wr}% Winrate</r2><br>
                        <r2>Elo: ${elo}</r2><br>
                        <r2>${(mvp / totalGames * 100).toFixed(1)}% MVP Rate</r2>
                    `;
                    document.querySelectorAll('.state-button').forEach(btn => btn.classList.remove('active'));
                    document.getElementById(`btn-${state}`).classList.add('active');
                }
                document.addEventListener("DOMContentLoaded", () => switchState('Overall'));
            </script>
            {% for x in ["Teammates", "Enemies"] %}
                <div class="profile-div" style="position: relative;">
                    <table class="table table-sm table-hover scrollable"
                           style="display: inline-block; max-height: 145px; overflow: hidden; overflow-y: scroll; border-collapse: separate; text-align: center">
                        <tbody>
                            <tr>
                                <th><r3>{{ x }}</r3></th>
                                <th><r3>Games</r3></th>
                                <th><r3>Winrate</r3></th>
                                <th><r3>Elo</r3></th>
                            </tr>
                            {% for mate in player_dict[x] %}
                                {% set mate_dict = player_dict[x][mate] %}
                                <tr class="player-row" data-href="/load/{{ mate_dict["Playerid"] }}">
                                    <td style="text-align: left">
                                        <a style="text-decoration: none; color: white" href="/load/{{ mate_dict["Playerid"] }}" class="open-in-new-tab">
                                            <r3>{{ mate_dict["Playername"][:14] }}</r3>
                                        </a>
                                    </td>
                                    <td><r3>{{ mate_dict["Count"] }}</r3></td>
                                    <td><r3>{{ winrate([mate_dict["Wins"],mate_dict["Count"]]) }}%</r3></td>
                                    <td><r3>{{ plus_prefix(mate_dict["EloChange"]) }}</r3></td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <button style="position: absolute; font-size: 20px; padding: 0; background: none; border: none; right: -20px; top: -3px;"
                            class="btn btn-primary btn-sm fullscreen-btn"
                            data-bs-toggle="modal"
                            data-bs-target="#tableModal"
                            onclick="renderTableModal('{{ x }}')">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            {% endfor %}

            <div class="modal fade" id="tableModal" tabindex="-1" aria-labelledby="tableModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content" style="height: 90vh; background-color: #1c1c1c">
                        <div class="modal-header">
                            <h5 class="modal-title" id="tableModalLabel">Table Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="tableModalBody" style="overflow-y: auto;">
                            <!-- Search bar -->
                            <div style="margin-bottom: 10px;">
                                <input
                                    type="text"
                                    id="searchPlayer"
                                    class="form-control"
                                    placeholder="Search player by name"
                                    onkeyup="filterTable()"
                                />
                            </div>
                            <!-- Rendered table will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <div style="display: flex; flex-wrap: wrap; justify-content: space-evenly; width: 100%">
                <div class="profile-div">
                    <r2>Wave 1 Tendency:</r2><br>
                    <div style="display: flex">
                        {% for x in ["UpgradeKingAttack", "Snail", "Mythium32"] %}
                            <div class="fav-imgs" style="position: relative;">
                                <img style="width: var(--waveimgsize)"  src="https://cdn.legiontd2.com/icons/{{ x }}.png">
                                <r2 style="position: absolute; bottom: -4px; left: 0;" class="strokeText">{{ wave1[loop.index0] }}%</r2>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% for fav_category in [["Favorite Openers", "Opener", openers, "openstats"],
                                        ["Favorite Masterminds", "MMs", mms, "mmstats"],
                                        ["Favorite Legion Spells", "Spell", spells, "spellstats"]] %}
                    <div class="profile-div">
                        <r2>{{ fav_category[0] }}:</r2><br>
                        <div style="display: flex">
                        {% for key in fav_category[2] %}
                            <div class="fav-imgs" style="position: relative;">
                                {% if fav_category[3] == "mmstats" %}
                                    {% set url_key = key %}
                                {% else %}
                                    {% set url_key = key|lower %}
                                {% endif %}
                                <a style="color: white; text-decoration: none" href="/load/{{ playername }}/{{ fav_category[3] }}/{{ patch }}/{{ elo }}/{{ url_key }}">
                                    <img style="width: var(--waveimgsize)" src="{{ get_cdn(key, fav_category[1]) }}">
                                    <r2 class="strokeText" style="position: absolute; bottom: -4px; left: 0;">{{ winrate([fav_category[2][key], games], no_dec=True) }}%</r2>
                                </a>
                            </div>
                        {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div id="chart-container" style="position: relative;">
                <div class="input-group" style="position: absolute; right: 10px; top: 20px; z-index: 10; width: 150px">
                    <input type="number" id="dataLimit" class="form-control form-control-sm" style="width: 80px;" min="1" value="100">
                    <button class="btn btn-secondary btn-sm" onclick="updateChart()">Apply</button>
                </div>

                <!-- Chart -->
                <canvas id="myChart"></canvas>
            </div>
        </div>
    </div>
    <div style="text-align: center"><r2 style="font-size: 1.5rem"><b>Ranked Match History</b></r2></div>
    <div style="max-height: 90vh; overflow-y: scroll; border-radius: 10px; padding-top: 5px;
                display: flex; flex-direction: column; gap: 3px;" id="match-history">
    {% for game in history[:short_history] %}
        <div class="clickableDiv" style="position: relative; background: var(--blackBg); border-radius: 10px; display: flex; padding: 10px; text-decoration: none; color: inherit;">
            <div style="display: flex; gap: 5px; text-wrap: nowrap; width: 100%; justify-content: center">
                <div style="width: 40%">
                    <div>
                        <img style="vertical-align: middle; clip-path: circle(); width: var(--waveimgsize)" src="{{ game["EndWave"] }}">
                        {% if game["Result_String"][0] == "won" %}
                            <r2 style="color: #6af945; font-size: var(--textsize)">{{ game["Result_String"][1] }} ({{ game["EloChange"] }} Elo)</r2>
                        {% elif game["Result_String"][0] == "lost" %}
                            <r2 style="color: #d64444; font-size: var(--textsize)">{{ game["Result_String"][1] }} ({{ game["EloChange"] }} Elo)</r2>
                        {% else %}
                            <r2 style="color: #aeaeae; font-size: var(--textsize)">{{ game["Result_String"][1] }} ({{ game["EloChange"] }} Elo)</r2>
                        {% endif %}
                        {% if game["MVP"] %}
                            <r2 style="color: goldenrod; font-size: var(--textsize)">[MVP]</r2>
                        {% endif %}
                        {% if game.DoubleDown %}
                            <img title="Double Down" style="width: 24px; clip-path: circle(); width: var(--imgsize);" src="https://cdn.legiontd2.com/icons/Secret/DoubleDown.png">
                        {% endif %}
                    </div>
                    <div style="display: flex; gap: 5px; overflow: hidden">
                        <div style="position: relative;">
                            <img style="vertical-align: middle; clip-path: circle(); width: var(--imgsize); height: auto" src="{{ get_cdn(game["Mastermind"], "MMs") }}">
                            {% if game["Megamind"] %}
                                <img loading="lazy" style="top:0;left: 0; position: absolute; clip-path: circle(); width: calc(var(--imgsize) / 2)" src="https://cdn.legiontd2.com/icons/Items/Megamind.png">
                            {% endif %}
                        </div>
                        <div>
                            <img style="vertical-align: middle; clip-path: circle(); width: var(--imgsize); height: auto" src="https://cdn.legiontd2.com/Icons/Worker.png">
                            <r style="font-size: var(--textsize)">{{ game["Worker"] }}</r>
                        </div>
                        <div>
                            <img style="vertical-align: middle; clip-path: circle(); width: var(--imgsize); height: auto" src="{{ get_cdn(game["Spell"], "Spell") }}">
                        </div>
                        {% for opener_unit in game["Opener"].split(",")|reverse %}
                            <img style="vertical-align: middle; clip-path: circle(); width: var(--imgsize); height: auto" src="{{ get_cdn(opener_unit, "Unit", profile=True) }}">
                        {% endfor %}
                    </div>
                </div>
                <div style="display: flex; white-space: nowrap; gap: 20px; align-items: center; width: 40%">
                    {% for x in [game["players_data"][:2], game["players_data"][2:]] %}
                        <div style="width: 50%">
                            {% for player in x %}
                                {% if player[3] == playerid %}
                                    {% set color = "#34a9db" %}
                                {% else %}
                                    {% set color = "white" %}
                                {% endif %}
                                <a class="matchhistoryPlayerName" style="color: white; text-decoration: none; padding: 5px; z-index: 9; position: relative" href="/load/{{ player[3] }}">
                                    <img style="width: 16px;" src="{{ get_rank_url(player[1]) }}">
                                    <r2 style="font-size: var(--textsize); color: {{ color }}">{{ player[0] }}</r2>
                                    {% if player[2] > 1 %}
                                        <img style="width: 16px;" src="/static/party.png">
                                    {% endif %}
                                </a><br>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
                <div style="width: 20%; position: relative;">
                    <div style="position: absolute; top: -15%; right: 0">
                        <r2 style="color: #a5a5a5; font-size: var(--textsize)">{{ game["time_ago"] }}</r2>
                    </div>
                    <div style="position: absolute; bottom: -15%; right: 0">
                        <r2 style="color: #a5a5a5; font-size: var(--textsize)">{{ game["Version"] }}</r2>
                    </div>
                </div>
            </div>
            <a href="{{ game["gamelink"] }}" class="overlay-link" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></a>
        </div>
    {% endfor %}
    <div id="loading-spinner" style="display: none;">
        <div class="spinner"></div>
    </div>
    </div>
</div>
<style>
    th {
        cursor: pointer;
        position: relative;
    }

    th .sort-indicator {
        margin-left: 5px;
        display: inline-block;
        transition: transform 0.3s ease-in-out;
    }

    th.ascending .sort-indicator {
        transform: rotate(0deg);
    }

    th.descending .sort-indicator {
        transform: rotate(180deg);
    }
</style>
<script>
    const playerDict = {{ player_dict | tojson }};

    function renderTableModal(tableKey) {
        const modalTitle = document.getElementById("tableModalLabel");
        const modalBody = document.getElementById("tableModalBody");
        modalTitle.textContent = `${tableKey} Data`;

        modalBody.innerHTML = `
            <div style="margin-bottom: 10px;">
                <input
                    type="text"
                    id="searchPlayer"
                    class="form-control"
                    placeholder="Search player by name"
                    onkeyup="filterTable()"
                />
            </div>
        `;

        const tableData = playerDict[tableKey];
        if (!tableData) {
            modalBody.innerHTML += "<p>No data available</p>";
            return;
        }

        const table = document.createElement("table");
        table.className = "table table-bordered table-hover";
        table.id = "sortableTable";
        table.style.width = "100%";

        const thead = document.createElement("thead");
        thead.innerHTML = `
            <tr>
                <th onclick="sortTable(0)">Playername <span class="sort-indicator">▼</span></th>
                <th onclick="sortTable(1)">Games <span class="sort-indicator">▼</span></th>
                <th>Win-Lose</th>
                <th onclick="sortTable(3)">Winrate <span class="sort-indicator">▼</span></th>
                <th onclick="sortTable(4)">Elo <span class="sort-indicator">▼</span></th>
            </tr>
        `;
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        tbody.id = "tableBody";

        Object.keys(tableData).forEach(playerId => {
            const player = tableData[playerId];
            const winrate = ((player.Wins / player.Count) * 100).toFixed(2);
            const losses = player.Count - player.Wins;

            const row = document.createElement("tr");
            row.innerHTML = `
                <td style="text-align: left; color: white;">
                    <a href="/load/${player.Playerid}" style="text-decoration: none; color: white;">${player.Playername}</a>
                </td>
                <td>${player.Count}</td>
                <td>${player.Wins} - ${losses}</td>
                <td>${winrate}%</td>
                <td>${player.EloChange > 0 ? "+" : ""}${player.EloChange}</td>
            `;
            tbody.appendChild(row);
        });

        table.appendChild(tbody);
        modalBody.appendChild(table);
        sortTable(1);
    }

    function sortTable(columnIndex) {
        const table = document.getElementById("sortableTable");
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.rows);

        const currentHeader = table.querySelectorAll("th")[columnIndex];
        const isDescending = !currentHeader.classList.contains("descending");

        table.querySelectorAll("th").forEach(th => th.classList.remove("ascending", "descending"));

        if (isDescending) {
            currentHeader.classList.add("descending");
        } else {
            currentHeader.classList.add("ascending");
        }

        rows.sort((a, b) => {
            const aText = a.cells[columnIndex].textContent.trim();
            const bText = b.cells[columnIndex].textContent.trim();

            const parseValue = (text) => {
                if (text.endsWith('%')) {
                    return parseFloat(text.slice(0, -1));
                }
                return isNaN(text) ? text : parseFloat(text);
            };

            const aValue = parseValue(aText);
            const bValue = parseValue(bText);

            if (aValue < bValue) return isDescending ? 1 : -1;
            if (aValue > bValue) return isDescending ? -1 : 1;
            return 0;
        });

        rows.forEach(row => tbody.appendChild(row));
    }

    function filterTable() {
        const input = document.getElementById("searchPlayer");
        const filter = input.value.toLowerCase();
        const tbody = document.getElementById("tableBody");
        const rows = tbody.rows;

        for (let i = 0; i < rows.length; i++) {
            const playerCell = rows[i].cells[0];
            const playerName = playerCell.textContent || playerCell.innerText;

            if (playerName.toLowerCase().includes(filter)) {
                rows[i].style.display = "";
            } else {
                rows[i].style.display = "none";
            }
        }
    }
</script>
<script>
    const playerName = "{{ api_profile['playerName'] }}";
    const playerId = "{{ playerid }}";
    const patch = "{{ patch }}";
    let currentPage = 1;
    let isLoading = false;
    let allGamesLoaded = false;

    function getRankUrl(elo) {
        if (typeof elo !== 'number') {
            elo = parseInt(elo, 10);
            if (isNaN(elo)) return null;
        }

        if (elo >= 2800) {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/Legend.png';
        } else if (elo >= 2600) {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/GrandMaster.png';
        } else if (elo >= 2400) {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/SeniorMaster.png';
        } else if (elo >= 2200) {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/Master.png';
        } else if (elo >= 2000) {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/Expert.png';
        } else if (elo >= 1800) {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/Diamond.png';
        } else if (elo >= 1600) {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/Platinum.png';
        } else if (elo >= 1400) {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/Gold.png';
        } else if (elo >= 1200) {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/Silver.png';
        } else {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/Bronze.png';
        }
    }

    function getUnitName(name) {
        if (!name) return "";

        let splitChar = name.includes("_") ? "_" : " ";
        if (name.includes("_unit_id")) {
            name = name.split("_unit_id")[0];
            if (name.startsWith(" ")) {
                name = name.slice(1);
            }
        }

        let newString = name.split(splitChar).map(str => str.charAt(0).toUpperCase() + str.slice(1)).join("");

        switch (newString) {
            case "HellRaiserBuffed":
                return "HellRaiser";
            case "PackRat(footprints)":
            case "PackRatNest":
                return "PackRat(Footprints)";
            case "Aps":
                return "APS";
            case "Mps":
                return "MPS";
            default:
                return newString;
        }
    }

    function getCDN(string, header, profile = false) {
        if (header === "Unit") {
            if (string === "Save") return "/static/save.png";
            if (!string && profile) return "https://cdn.legiontd2.com/icons/Worker.png";
            return `https://cdn.legiontd2.com/icons/${getUnitName(string)}.png`;
        }

        if (header === "MMs") {
            return `https://cdn.legiontd2.com/icons/Items/${string}.png`;
        }

        if (header === "Spell") {
            return `https://cdn.legiontd2.com/icons/${getUnitName(string)
                .replace("PresstheAttack", "PressTheAttack")
                .replace("None", "Granddaddy")}.png`;
        }
        return "";
    }

    function createGameElement(game) {
        const gameDiv = document.createElement('div');
        gameDiv.className = 'clickableDiv';
        gameDiv.style.cssText = "position: relative; background: var(--blackBg); border-radius: 10px; display: flex; padding: 10px; text-decoration: none; color: inherit;";

        let color;
        console.log(game.Result_String[0])
        if (game.Result_String[0] === "won") {
            color = "#6af945"; // Green
        } else if (game.Result_String[0] === "lost") {
            color = "#d64444"; // Red
        } else {
            color = "#aeaeae"; // Gray (default case)
        }

        const resultHTML = `<r2 style="color: ${color}; font-size: var(--textsize)">
            ${game.Result_String[1]} (${game.EloChange} Elo)
        </r2>`;


        gameDiv.innerHTML = `
            <div style="display: flex; gap: 5px; text-wrap: nowrap; width: 100%; justify-content: center">
                <div style="width: 40%">
                    <div>
                        <img style="vertical-align: middle; clip-path: circle(); width: var(--waveimgsize)" src="${game.EndWave}">
                        ${resultHTML}
                        ${game.MVP
                            ? `<r2 style="color: goldenrod; font-size: var(--textsize)">[MVP]</r2>`
                            : ""}
                        ${game.DoubleDown ? `<img title="Double Down" style="width: 24px; clip-path: circle(); width: var(--imgsize);" src="https://cdn.legiontd2.com/icons/Secret/DoubleDown.png">` : ""}
                    </div>
                    <div style="display: flex; gap: 5px; overflow: hidden">
                        <div style="position: relative;">
                            <img style="vertical-align: middle; clip-path: circle(); width: var(--imgsize); height: auto" src="${getCDN(game.Mastermind, 'MMs')}">
                            ${game.Megamind
                                ? `<img loading="lazy" style="top:0;left: 0; position: absolute; clip-path: circle(); width: calc(var(--imgsize) / 2)" src="https://cdn.legiontd2.com/icons/Items/Megamind.png">`
                                : ''}
                        </div>
                        <div>
                            <img style="vertical-align: middle; clip-path: circle(); width: var(--imgsize); height: auto" src="https://cdn.legiontd2.com/Icons/Worker.png">
                            <r style="font-size: var(--textsize)">${game.Worker}</r>
                        </div>
                        <div>
                            <img style="vertical-align: middle; clip-path: circle(); width: var(--imgsize); height: auto" src="${getCDN(game.Spell, 'Spell')}">
                        </div>
                        ${game.Opener.split(',').reverse().map(openerUnit => `
                            <img style="vertical-align: middle; clip-path: circle(); width: var(--imgsize); height: auto" src="${getCDN(openerUnit, 'Unit', true)}">
                        `).join('')}
                    </div>
                </div>
                <div style="display: flex; white-space: nowrap; gap: 20px; align-items: center; width: 40%">
                    ${[game.players_data.slice(0, 2), game.players_data.slice(2)].map(group => `
                        <div style="width: 50%">
                            ${group.map(player => `
                                <a class="matchhistoryPlayerName" style="color: white; text-decoration: none; padding: 5px; z-index: 9; position: relative" href="/load/${player[3]}">
                                    <img style="width: 16px;" src="${getRankUrl(player[1])}">
                                    <r2 style="font-size: var(--textsize); color: ${player[3] === playerId ? '#34a9db' : 'white'}">${player[0]}</r2>
                                    ${player[2] > 1 ? `<img style="width: 16px;" src="/static/party.png">` : ""}
                                </a><br>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
                <div style="width: 20%; position: relative;">
                    <div style="position: absolute; top: -15%; right: 0">
                        <r2 style="color: #a5a5a5; font-size: var(--textsize)">${game.time_ago}</r2>
                    </div>
                    <div style="position: absolute; bottom: -15%; right: 0">
                        <r2 style="color: #a5a5a5; font-size: var(--textsize)">${game.Version}</r2>
                    </div>
                </div>
            </div>
            <a href="${game.gamelink}" class="overlay-link" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></a>
        `;

        return gameDiv;
    }

    async function loadMoreGames() {
        if (isLoading) return;
        if (allGamesLoaded) return;
        isLoading = true;

        const url = `/api/get_player_matchhistory/${playerName}/${playerId}/${patch}/${currentPage}`;
        console.log(url);

        let spinnerTimeout;
        const spinner = document.getElementById('loading-spinner');
        spinner.style.display = 'none';

        try {
            spinner.style.display = 'block';
            const response = await fetch(url);
            if (!response.ok) {
                allGamesLoaded = true;
                throw new Error("Failed to fetch data");
            }

            const data = await response.json();

            const matchHistoryDiv = document.getElementById('match-history');
            data.forEach(game => {
                const gameElement = createGameElement(game);
                matchHistoryDiv.appendChild(gameElement);
            });

            currentPage++;
        } catch (error) {
            console.error("Error loading more games:", error);
        } finally {
            isLoading = false;
            setTimeout(() => {
                clearTimeout(spinnerTimeout);
                spinner.style.display = 'none';
            }, 200);
        }
    }

    const matchHistoryDiv = document.getElementById('match-history');
    matchHistoryDiv.addEventListener('scroll', () => {
        if (
            matchHistoryDiv.scrollTop + matchHistoryDiv.clientHeight >=
            matchHistoryDiv.scrollHeight - 10
        ) {
            loadMoreGames();
        }
    });
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const labels = {{ labels|tojson }};
    const values = {{ values|tojson }};
    const dataLength = labels.length;
    const rankImagesCache = {};
    const baseUrl = window.location.origin.includes('127.0.0.1')
        ? 'https://drachbot.site'
        : '';

    $(document).ready(function () {
        var playerid = "{{ playerid }}";
        var refreshBtn = $('#refresh-btn');
        checkRefreshStatus(playerid, true);
        // Handle button click
        refreshBtn.click(function () {
            refreshBtn.prop('disabled', true).text('Refreshing...');

            // Make AJAX request to start refresh process
            $.get('/api/request_games/' + playerid, function (response) {
                // Request successful, now wait for the process to finish
                checkRefreshStatus(playerid, false);
            }).fail(function (response) {
                alert(response.responseJSON.error);
                console.log(response.responseJSON.error);
                refreshBtn.prop('disabled', false).text('Refresh');
            });
        });

        // Polling function to check refresh status periodically
        function checkRefreshStatus(playerid, initial) {
            $.get('/api/check_refresh_status/' + playerid, function (data) {
                if (!data.in_progress && data.cooldown > 0 && !initial) {
                    window.location.reload();
                } else if (data.in_progress) {
                    refreshBtn.prop('disabled', true).text('Refreshing...');
                    // Keep polling until the process finishes
                    setTimeout(function () {
                        checkRefreshStatus(playerid, false);
                    }, 3000);  // Poll every 3 seconds
                }
            });
        }
    });

    $(document).ready(function () {
        const playerName = "{{ api_profile['playerName'] }}";  // Get the player's name dynamically

        // Function to format the duration (rounded to minutes and seconds)
        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);  // Rounded to nearest second
            return `${minutes}m ${remainingSeconds}s`;
        }

        // Function to check if the player is in a game
        function checkLiveGameStatus() {
            $.get(baseUrl + `/api/livegames/${playerName}`, function (data) {
                if (data.length > 0) {
                    let button = $('#check-livegame-btn');
                    button.addClass('highlight');
                }
            }).fail(function () {
                console.error('Failed to retrieve live game status.');
            });
        }

        // Check on page load
        checkLiveGameStatus();

        // Function to update the game duration in real-time
        function updateGameDuration(startTime, element) {
            setInterval(function () {
                const currentTime = Math.floor(Date.now() / 1000);  // Get current time in seconds
                const gameDurationInSeconds = currentTime - startTime;  // Duration in seconds
                const formattedDuration = formatDuration(gameDurationInSeconds);  // Format duration
                $(element).text(formattedDuration);  // Update the element's text with new duration
            }, 1000);  // Update every second
        }
        // Handle live game check button click
        $('#check-livegame-btn').click(function () {
            $.get(baseUrl + `/api/livegames/${playerName}`, function (data) {
                if (data.length > 0) {
                    const gameStartTime = data[0];  // Game start time (in seconds)
                    let gameElo = data[1];
                    let westPlayers = data[2]; // Team 1
                    let eastPlayers = data[3]; // Team 2

                    // Calculate sellout scores
                    const calculateSelloutScore = (you, teammate, opponent, other) => you + other - teammate - opponent;

                    const westSelloutScores = westPlayers.map((player, index) => {
                        const you = parseInt(player[1]);
                        const teammate = parseInt(westPlayers[1 - index][1]); // teammate is the other player in the same team
                        const opponent = parseInt(eastPlayers[index][1]); // opponent is aligned by sending order
                        const other = parseInt(eastPlayers[1 - index][1]); // other opponent
                        return calculateSelloutScore(you, teammate, opponent, other);
                    });

                    const eastSelloutScores = eastPlayers.map((player, index) => {
                        const you = parseInt(player[1]);
                        const teammate = parseInt(eastPlayers[1 - index][1]); // teammate is the other player in the same team
                        const opponent = parseInt(westPlayers[1 - index][1]); // opponent is aligned by sending order
                        const other = parseInt(westPlayers[index][1]); // other opponent
                        return calculateSelloutScore(you, teammate, opponent, other);
                    });

                    // Build the game details HTML
                    const gameHTML = `
                        <div class="game-card card text-white mb-3" style="background-color: #1c1c1c">
                            <div class="card-body">
                                <div class="game-header mb-3">
                                    <div style="display: flex; justify-content: space-between; align-items: center; white-space: nowrap; height: 40px; gap: 30px; flex-wrap: wrap">
                                        <div>
                                            Game Elo: ${gameElo}
                                        </div>
                                        <div>
                                            Game Time: <span id="game-duration">${formatDuration(0)}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="players-container d-flex justify-content-between">
                                    <div class="team west-team text-center">
                                        ${westPlayers.map((player, index) => `
                                            <a class="player d-block mb-2" style="color: white; text-decoration: none;" href="/profile/${player[0]}">
                                                <img src="${getRankUrl(player[1])}" class="rounded-circle mb-1" alt="${player[0]} rank" style="width: 32px;">
                                                <span>${player[0]}</span>
                                                <div class="rankHover" data-type="elo" style="display: block;">${player[1]}</div>
                                                <div class="rankHover" data-type="sellout" style="display: none;">${westSelloutScores[index]}</div>
                                            </a>
                                        `).join('')}
                                    </div>

                                    <div class="team east-team text-center">
                                        ${eastPlayers.map((player, index) => `
                                            <a class="player d-block mb-2" style="color: white; text-decoration: none;" href="/profile/${player[0]}">
                                                <img src="${getRankUrl(player[1])}" class="rounded-circle mb-1" alt="${player[0]} rank" style="width: 32px;">
                                                <span>${player[0]}</span>
                                                <div class="rankHover" data-type="elo" style="display: block;">${player[1]}</div>
                                                <div class="rankHover" data-type="sellout" style="display: none;">${eastSelloutScores[index]}</div>
                                            </a>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Insert the HTML into the modal body and show the modal
                    $('#liveGameDetails').html(gameHTML);
                    $('#liveGameModal').modal('show');

                    // Start real-time update for game duration
                    updateGameDuration(gameStartTime, '#game-duration');

                    // Toggle Elo / Sellout Score display when the button is clicked
                    $('#elo-toggle').click(function() {
                        $('#elo-toggle').addClass('active');
                        $('#sellout-toggle').removeClass('active');
                        $('.rankHover[data-type="elo"]').show();
                        $('.rankHover[data-type="sellout"]').hide();
                    });

                    $('#sellout-toggle').click(function() {
                        $('#sellout-toggle').addClass('active');
                        $('#elo-toggle').removeClass('active');
                        $('.rankHover[data-type="sellout"]').show();
                        $('.rankHover[data-type="elo"]').hide();
                    });
                } else {
                    alert('The player is not currently in a game.');
                }
            }).fail(function () {
                alert('Failed to retrieve live game status.');
            });
        });

    });

    function getRankUrl(elo) {
        if (typeof elo !== 'number') {
            elo = parseInt(elo, 10);
            if (isNaN(elo)) return null;
        }

        if (elo >= 2800) {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/Legend.png';
        } else if (elo >= 2600) {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/GrandMaster.png';
        } else if (elo >= 2400) {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/SeniorMaster.png';
        } else if (elo >= 2200) {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/Master.png';
        } else if (elo >= 2000) {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/Expert.png';
        } else if (elo >= 1800) {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/Diamond.png';
        } else if (elo >= 1600) {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/Platinum.png';
        } else if (elo >= 1400) {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/Gold.png';
        } else if (elo >= 1200) {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/Silver.png';
        } else if (elo >= 1000) {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/Silver.png';
        } else {
            return 'https://cdn.legiontd2.com/icons/Ranks/Simple/Unranked.png';
        }
    }


    function preloadRankImages(callback) {
        const rankThresholds = [
            { rank: 3000, url: 'https://cdn.legiontd2.com/icons/Ranks/Simple/Legend.png' },
            { rank: 2800, url: 'https://cdn.legiontd2.com/icons/Ranks/Simple/Legend.png' },
            { rank: 2600, url: 'https://cdn.legiontd2.com/icons/Ranks/Simple/GrandMaster.png' },
            { rank: 2400, url: 'https://cdn.legiontd2.com/icons/Ranks/Simple/SeniorMaster.png' },
            { rank: 2200, url: 'https://cdn.legiontd2.com/icons/Ranks/Simple/Master.png' },
            { rank: 2000, url: 'https://cdn.legiontd2.com/icons/Ranks/Simple/Expert.png' },
            { rank: 1800, url: 'https://cdn.legiontd2.com/icons/Ranks/Simple/Diamond.png' },
            { rank: 1600, url: 'https://cdn.legiontd2.com/icons/Ranks/Simple/Platinum.png' },
            { rank: 1400, url: 'https://cdn.legiontd2.com/icons/Ranks/Simple/Gold.png' },
            { rank: 1200, url: 'https://cdn.legiontd2.com/icons/Ranks/Simple/Silver.png' },
            { rank: 1000, url: 'https://cdn.legiontd2.com/icons/Ranks/Simple/Bronze.png' },
            { rank: 0, url: 'https://cdn.legiontd2.com/icons/Ranks/Simple/Unranked.png' }
        ];

        let loadedImagesCount = 0;
        const totalImages = rankThresholds.length;

        rankThresholds.forEach(rankObj => {
            const img = new Image();
            img.src = rankObj.url;
            img.onload = function() {
                rankImagesCache[rankObj.rank] = img;
                loadedImagesCount++;
                // Once all images are preloaded, call the callback
                if (loadedImagesCount === totalImages) {
                    callback();
                }
            };
            img.onerror = function() {
                console.error('Failed to load image:', rankObj.url);
            };
        });
    }

    function getRankImageForValue(value) {
        if (value >= 3000) return rankImagesCache[3000];
        if (value >= 2800) return rankImagesCache[2800];
        if (value >= 2600) return rankImagesCache[2600];
        if (value >= 2400) return rankImagesCache[2400];
        if (value >= 2200) return rankImagesCache[2200];
        if (value >= 2000) return rankImagesCache[2000];
        if (value >= 1800) return rankImagesCache[1800];
        if (value >= 1600) return rankImagesCache[1600];
        if (value >= 1400) return rankImagesCache[1400];
        if (value >= 1200) return rankImagesCache[1200];
        if (value >= 1000) return rankImagesCache[1000];
        return rankImagesCache[0];
    }

    function getLineColor(value) {
        if (value >= 3000) return 'rgb(67,103,220)';
        if (value >= 2800) return 'rgb(43,52,135)';
        if (value >= 2600) return 'rgb(216,153,191)';
        if (value >= 2400) return 'rgb(50,179,161)';
        if (value >= 2200) return 'rgb(178,66,191)';
        if (value >= 2000) return 'rgb(184,4,4)';
        if (value >= 1800) return 'rgb(0,151,255)';
        if (value >= 1600) return 'rgb(24,78,80)';
        if (value >= 1400) return 'rgb(255, 165, 0)';
        if (value >= 1200) return 'rgb(192, 192, 192)';
        if (value >= 1000) return 'rgb(139, 69, 19)';
        return 'rgb(129,129,129)';
    }

    const customPlugin = {
        id: 'customPlugin',
        afterDatasetsDraw(chart) {
            const ctx = chart.ctx;
            const meta = chart.getDatasetMeta(0);
            const dataPoints = meta.data;
            const values = chart.data.datasets[0].data;

            // Loop through the data points and draw segments
            ctx.save(); // Save the current context
            for (let i = 0; i < dataPoints.length - 1; i++) {
                const startPoint = dataPoints[i];
                const endPoint = dataPoints[i + 1];
                const color = getLineColor(values[i]);

                // Set the stroke color
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;

                ctx.beginPath(); // Start a new path
                ctx.moveTo(startPoint.x, startPoint.y);
                ctx.lineTo(endPoint.x, endPoint.y);
                ctx.stroke(); // Draw the segment
            }
            ctx.restore(); // Restore the context to its original state

            // Draw threshold icons for the Y-axis ticks
            const yScale = chart.scales.y;

            yScale.ticks.forEach(tick => {
                const value = tick.value;
                const img = getRankImageForValue(value);
                if (img) { // Draw icons for each threshold
                    const tickX = yScale.left - 50; // Position icon to the left of the tick label
                    const tickY = yScale.getPixelForValue(value) - 16; // Calculate Y position for the tick
                    ctx.drawImage(img, tickX + 8, tickY + 6, 20, 20); // Draw the image
                    // Draw the label value next to the icon
                    ctx.fillStyle = 'rgba(204,204,204,1)';
                    ctx.font = '10px Arial';
                    ctx.fillText(value, tickX + 30, tickY + 18); // Adjust position to avoid overlap
                }
            });

            // Draw threshold icons on data points where thresholds change
            let lastDrawnIndex = -1; // Initialize the last drawn index to avoid duplicates
            for (let i = 0; i < dataPoints.length; i++) {
                const currentValue = chart.data.datasets[0].data[i];
                const previousValue = chart.data.datasets[0].data[i - 1];
                if (getRankImageForValue(currentValue) !== getRankImageForValue(previousValue) &&
                    (i - lastDrawnIndex > 4)) { // Limit icon frequency (at least 5 points apart)

                    const dataPoint = dataPoints[i];
                    const rankImage = getRankImageForValue(currentValue);
                    ctx.drawImage(rankImage, dataPoint.x - 12, dataPoint.y - 12, 20, 20);
                    lastDrawnIndex = i; // Update last drawn index
                }
            }
        }
    };

    // Declare myChart globally so it can be accessed inside updateChart
    let myChart;

    // Initialize chart after images are preloaded
    preloadRankImages(function() {
        const ctx = document.getElementById('myChart').getContext('2d');

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '',
                    data: values,
                    backgroundColor: 'rgba(0,0,0,0)',
                    borderColor: 'rgba(0,0,0,0)',
                    borderWidth: 2,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: {
                            maxTicksLimit: 25,
                            font: {
                                size: 12
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.2)',
                            borderColor: 'rgba(255, 255, 255, 0.5)',
                            borderWidth: 1
                        }
                    },
                    y: {
                        beginAtZero: false,
                        ticks: {
                            font: {
                                size: 0
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.2)',
                            borderColor: 'rgba(255, 255, 255, 0.5)',
                            borderWidth: 1
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: `Last ${labels.length} Ranked Games`,
                        color: 'rgb(204,204,204)',
                        font: {
                            size: 14
                        },
                        padding: {
                            top: 10
                        }
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'nearest',
                        intersect: false
                    }
                },
                layout: {
                    padding: {
                        top: 5,
                        bottom: 5,
                        left: 20,
                    }
                }
            },
            plugins: [customPlugin]  // Use custom plugin to handle drawing
        });

        // Refresh the chart
        myChart.update();
    });

    // Function to update chart based on user input
    function updateChart() {
        let limit = parseInt(document.getElementById('dataLimit').value, 10);

        // Adjust limit if it exceeds available data length
        if (limit > dataLength) {
            limit = dataLength;
        }

        const newLabels = labels.slice(-limit);
        const newValues = values.slice(-limit);

        myChart.data.labels = newLabels;
        myChart.data.datasets[0].data = newValues;
        myChart.options.plugins.title.text = `Last ${newLabels.length} Ranked Games`
        myChart.update(); // Refresh the chart with new data
    }

    // Initialize the input field with the maximum value based on the data length
    document.getElementById('dataLimit').setAttribute('max', dataLength);
    document.getElementById('dataLimit').value = Math.min(100, dataLength); // Default to 100 or max available data

    document.addEventListener('DOMContentLoaded', () => {
    const clickableDivs = document.querySelectorAll('.clickableDiv');
    clickableDivs.forEach(div => {
        div.addEventListener('click', (e) => {
            if (e.target.tagName !== 'A') {
                const url = div.getAttribute('data-href');
                if (url) {
                        window.location.href = url;
                    }
                }
            });
        });
    });
</script>
<script src="/static/profile_patches.js"></script>
{% endblock %}