{% extends 'base.html' %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div class="container-lg" style="padding-top: 2vw; display: flex; gap: 20px; justify-content: center; align-items: flex-start; flex-wrap: wrap">
    <div class="profile-main">
        <div style="padding: 10px; display: flex; flex-wrap: wrap; overflow: hidden; align-items: flex-start; justify-content: center">
            <div style="text-align: center; width: 250px; overflow: hidden">
                <img style="vertical-align: middle; clip-path: circle();" src="https://cdn.legiontd2.com/{{ api_profile["avatarUrl"] }}">
                <r2 style="font-size: 1.5rem"><b>{{ api_profile["playerName"] }}</b></r2>
                <r2 style="color: gold;"><b> {{ api_profile["guildTag"] }}</b></r2><br>
                <button class="btn btn-secondary" onclick="refreshPage()">Refresh</button>
            </div>
            <div class="profile-div">
                <r2 style=""><b>Season 2024 Stats</b></r2><br>
                <r2>{{ api_stats["rankedWinsThisSeason"] }}W - {{ api_stats["rankedLossesThisSeason"] }}L<br>({{ winrate([api_stats["rankedWinsThisSeason"],
                (api_stats["rankedWinsThisSeason"]+api_stats["rankedLossesThisSeason"])]) }} WR%)</r2><br>
                <img width="32" height="auto" style="vertical-align: middle" src="{{ get_rank_url(api_stats["overallElo"]) }}">
                <r2>{{ api_stats["overallElo"] }} </r2><r2 style="color: #919191">Current</r2><br>
                <img width="32" height="auto" style="vertical-align: middle" src="{{ get_rank_url(api_stats["overallPeakEloThisSeason"]) }}">
                <r2>{{ api_stats["overallPeakEloThisSeason"] }} </r2><r2 style="color: #919191">Peak</r2>
            </div>
            <div class="profile-div">
                <r2><b>Last {{ history|length }} Games</b></r2><br>
                <r2>{{ winlose[0] }}W - {{ winlose[1] }}L<br>({{ winrate([winlose[0], (winlose[0]+winlose[1])]) }} WR%)</r2><br>
                <r2>Elo Diff: {{ elochange }}</r2>
            </div>
            <div class="profile-div">
                  <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                      <r><b>Stats Pages</b></r>
                  </button>
                <ul class="dropdown-menu bg-black">
                    {% for stat in stats_list %}
                        <li class="dropdown-item">
                            <a style="color: white; text-decoration: none;" href="/profile/{{ playername }}/{{ stat }}">
                            <img width="32" height="auto" style="vertical-align: middle" src="{{ image_list[loop.index0]}}">
                            <r2>{{ stat.capitalize() }}</r2><br></a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="profile-div">
                <r2>Wave 1 Tendency:</r2><br>
                <img width="36" height="auto" src="https://cdn.legiontd2.com/icons/UpgradeKingAttack.png"><r2>{{ wave1[0] }}%</r2>
                <img width="36" height="auto" src="https://cdn.legiontd2.com/icons/Snail.png"><r2>{{ wave1[1] }}%</r2>
                <img width="36" height="auto" src="https://cdn.legiontd2.com/icons/Mythium32.png"><r2>{{ wave1[2] }}%</r2>
            </div>
            <div class="profile-div">
                <r2>Favorite Openers:</r2><br>
                {% for open in openers %}
                    <img width="36" height="auto" src="{{ get_cdn(open, "Opener") }}">
                {% endfor %}
            </div>
            <div class="profile-div">
                <r2>Favorite Masterminds:</r2><br>
                {% for mm in mms %}
                    <img width="36" height="auto" src="{{ get_cdn(mm, "MMs") }}">
                {% endfor %}
            </div>
            <div id="chart-container" style="position: relative;">
                <div class="input-group" style="position: absolute; right: 10px; top: 20px; z-index: 10; width: 150px">
                    <input type="number" id="dataLimit" class="form-control form-control-sm" style="width: 80px;" min="1" value="100">
                    <button class="btn btn-secondary btn-sm" onclick="updateChart()">Apply</button>
                </div>

                <!-- Chart -->
                <canvas id="myChart"></canvas>
            </div>
        </div>
    </div>
    <div style="max-height: 85vh; overflow-y: scroll; border-radius: 10px;">
        <r2 style="font-size: 1.5rem">Match History</r2>
    {% for game in history %}
        <div style="background: #171717; border-radius: 10px; display: flex; padding-right: 10px; justify-content: center">
            <div>
                <div>
                    <a style="color: white; text-decoration: none;"  href="{{ game["gamelink"] }}">
                        <img width="48" style="vertical-align: middle; clip-path: circle();" src="{{ game["EndWave"] }}">
                        {% if game["Result_String"][0] %}
                            <r2 style="color: #6af945">{{ game["Result_String"][1] }} ({{ game["EloChange"] }} Elo)</r2>
                        {% else %}
                            <r2 style="color: #d64444">{{ game["Result_String"][1] }} ({{ game["EloChange"] }} Elo)</r2>
                        {% endif %}
                    </a>
                </div>
                <div style="display: flex; white-space: nowrap; justify-content: center;  gap: 20px">
                    {% for x in [game["players_data"][:2], game["players_data"][2:]] %}
                        <div>
                            {% for player in x %}
                                {% if player[0] == api_profile["playerName"] %}
                                    {% set color = "#34a9db" %}
                                {% else %}
                                    {% set color = "white" %}
                                {% endif %}
                                <a style="color: white; text-decoration: none;"  href="/profile/{{ player[0] }}">
                                    <img style="width: 16px;" src="{{ get_rank_url(player[1]) }}">
                                    <r2 style="font-size: 0.8rem; color: {{ color }}">{{ player[0] }}</r2></a><br>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
                <a style="color: white; text-decoration: none;"  href="{{ game["ltd2pro"] }}">
                    <div style="float: right">
                        <r2 style="color: #a5a5a5;">{{ game["time_ago"] }}</r2><r2>ðŸ”—</r2>
                    </div></a>
            </div>
        </div><br>
    {% endfor %}
    </div>
</div>
<script>
    // Get the labels and values from Flask (Jinja2 templating)
    const labels = {{ labels|tojson }};
    const values = {{ values|tojson }};
    const dataLength = labels.length;

    // Set up the chart
    const ctx = document.getElementById('myChart').getContext('2d');
    let myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Elo',
                data: values,
                backgroundColor: 'rgba(67,144,255,0.91)',
                borderColor: 'rgb(79,189,237)',
                borderWidth: 1,
                pointRadius: 0  // Remove dots
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    ticks: {
                        maxTicksLimit: 20,
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.2)',
                        borderColor: 'rgba(255, 255, 255, 0.5)',
                        borderWidth: 1
                    }
                },
                y: {
                    beginAtZero: false,
                    ticks: {
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.2)',
                        borderColor: 'rgba(255, 255, 255, 0.5)',
                        borderWidth: 1
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: `Last ${labels.length} Ranked Games`,
                    color: 'rgb(204,204,204)',
                    font: {
                        size: 14  // Smaller title font size
                    },
                    padding: {
                        top: 10,  // Reduce space above title
                        bottom: 10  // Ensure some space below title
                    }
                },
                tooltip: {
                    enabled: true,
                    mode: 'nearest',
                    intersect: false
                }
            },
            layout: {
                padding: {
                    top: 5,  // Reduce padding at the top
                    bottom: 20
                }
            }
        }
    });

    // Function to update chart based on user input
    function updateChart() {
        let limit = parseInt(document.getElementById('dataLimit').value, 10);

        // Adjust limit if it exceeds available data length
        if (limit > dataLength) {
            limit = dataLength;
            document.getElementById('dataLimit').value = limit;
        }

        if (limit > 0) {
            const limitedLabels = labels.slice(-limit);
            const limitedValues = values.slice(-limit);

            // Update chart data
            myChart.data.labels = limitedLabels;
            myChart.data.datasets[0].data = limitedValues;

            // Recalculate min and max values
            const minValue = Math.min(...limitedValues);
            const maxValue = Math.max(...limitedValues);
            myChart.options.scales.y.min = minValue - 10;
            myChart.options.scales.y.max = maxValue + 10;

            // Update chart title
            myChart.options.plugins.title.text = `Last ${limit} Ranked Games`;

            // Refresh the chart
            myChart.update();
        } else {
            alert("Please enter a valid number greater than 0.");
        }
    }

    // Initialize the input field with the maximum value based on the data length
    document.getElementById('dataLimit').setAttribute('max', dataLength);
    document.getElementById('dataLimit').value = Math.min(100, dataLength); // Default to 100 or max available data
</script>

{% endblock %}